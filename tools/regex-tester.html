<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regex Tester - Helpful Tools v2</title>
    <link rel="stylesheet" href="/static/css/common-enhancements.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            font-size: 13px;
        }
        .header {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 8px 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions button,
        .header-actions a {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
            text-decoration: none;
        }
        .header-actions button:hover,
        .header-actions a:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .history-toggle-btn {
            background: linear-gradient(to bottom, #f0f8ff, #d1e7ff);
            border: 1px solid #4a90e2;
            color: #1565c0;
        }
        .history-toggle-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8f4fd);
        }
        .history-toggle-btn.disabled {
            background: linear-gradient(to bottom, #fff0f0, #fdd8d8);
            border-color: #dc3545;
            color: #c82333;
        }
        .history-toggle-btn.disabled:hover {
            background: linear-gradient(to bottom, #fff5f5, #ffe0e0);
        }
        .global-history-btn {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            color: #333;
        }
        .global-history-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        
        /* Font controls styling */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }
        
        .font-controls label {
            color: #333;
            margin: 0;
        }
        
        .font-controls button {
            font-size: 14px;
            padding: 2px 6px;
            font-weight: bold;
            min-width: 24px;
            height: 24px;
            border: 1px solid #a0a0a0;
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            cursor: pointer;
            border-radius: 2px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .font-controls button:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        
        .font-controls button:active {
            background: linear-gradient(to bottom, #e0e0e0, #f0f0f0);
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
        }
        .toolbar {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: sticky;
            top: 41px;
            z-index: 99;
        }
        .toolbar button {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        .toolbar button:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .toolbar button:active {
            background: linear-gradient(to bottom, #e0e0e0, #f0f0f0);
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
        }
        .toolbar button.primary {
            background: linear-gradient(to bottom, #4a90e2, #357abd);
            color: white;
            border: 1px solid #2968a3;
        }
        .toolbar button.primary:hover {
            background: linear-gradient(to bottom, #5ba0f2, #4a90e2);
        }
        .separator {
            width: 1px;
            height: 16px;
            background: #c0c0c0;
            margin: 0 2px;
        }
        .regex-section {
            background: linear-gradient(to bottom, #ffffff, #f8f8f8);
            border-bottom: 1px solid #c0c0c0;
            padding: 12px 16px;
        }
        .regex-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .regex-delimiters {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #666;
        }
        .regex-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #c0c0c0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            background: #ffffff;
            border-radius: 2px;
            outline: none;
        }
        .regex-input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 3px rgba(74, 144, 226, 0.3);
        }
        .regex-input.error {
            border-color: #d32f2f;
            background: #fff5f5;
        }
        .regex-input.valid {
            border-color: #388e3c;
        }
        .flags-section {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            margin-bottom: 8px;
        }
        .flag-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .flag-group label {
            color: #555;
            cursor: pointer;
        }
        .regex-error {
            color: #d32f2f;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            min-height: 14px;
        }
        .quick-examples {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .example-btn {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        .example-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .main-container {
            display: flex;
            height: calc(100vh - 200px);
            overflow: hidden;
        }
        .left-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #c0c0c0;
            min-width: 0;
        }
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .panel-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            border-bottom: 1px solid #c0c0c0;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .match-indicator {
            background: #4a90e2;
            color: white;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            font-weight: normal;
        }
        .match-indicator.matches {
            background: #388e3c;
        }
        .match-indicator.no-matches {
            background: #d32f2f;
        }
        .panel-content {
            flex: 1;
            position: relative;
            background: #ffffff;
            overflow: hidden;
            min-height: 0;
        }
        .test-text-area {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #ffffff;
            color: #000000;
            resize: none;
            overflow: auto;
            box-sizing: border-box;
        }
        .highlighted-text {
            width: 100%;
            height: 100%;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #ffffff;
            color: #000000;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-sizing: border-box;
        }
        .regex-match {
            background: #ffeb3b;
            border: 1px solid #ff9800;
            border-radius: 2px;
            padding: 0 1px;
            position: relative;
            cursor: pointer;
        }
        .regex-match:hover {
            background: #fff176;
            box-shadow: 0 0 3px rgba(255, 152, 0, 0.5);
        }
        .regex-match.group-0 { background: #ffeb3b; border-color: #ff9800; }
        .regex-match.group-1 { background: #e1f5fe; border-color: #0277bd; }
        .regex-match.group-2 { background: #f3e5f5; border-color: #7b1fa2; }
        .regex-match.group-3 { background: #e8f5e8; border-color: #2e7d32; }
        .regex-match.group-4 { background: #fff3e0; border-color: #ef6c00; }
        .regex-match.group-5 { background: #fce4ec; border-color: #c2185b; }
        .regex-match.group-6 { background: #f1f8e9; border-color: #689f38; }
        .regex-match.group-7 { background: #e8eaf6; border-color: #5e35b1; }
        .regex-match.group-8 { background: #fff8e1; border-color: #fbc02d; }
        .regex-match.group-9 { background: #fafafa; border-color: #616161; }
        .regex-no-match {
            color: #999;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        .matches-panel {
            border-top: 1px solid #c0c0c0;
            max-height: 40%;
            overflow-y: auto;
            background: #ffffff;
            display: none;
        }
        .matches-panel.show {
            display: block;
        }
        .matches-header {
            padding: 6px 12px;
            background: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
            font-size: 11px;
            font-weight: bold;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .match-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            cursor: pointer;
        }
        .match-item:hover {
            background: #f8f8f8;
        }
        .match-item.active {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        .match-index {
            color: #666;
            font-size: 10px;
            margin-right: 8px;
        }
        .match-text {
            background: #ffeb3b;
            padding: 1px 3px;
            border-radius: 2px;
            margin-right: 8px;
        }
        .match-position {
            color: #999;
            font-size: 10px;
        }
        .group-matches {
            margin-left: 20px;
            margin-top: 4px;
            font-size: 10px;
        }
        .group-match {
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 2px;
        }
        .group-match.group-1 { color: #0277bd; }
        .group-match.group-2 { color: #7b1fa2; }
        .group-match.group-3 { color: #2e7d32; }
        .group-match.group-4 { color: #ef6c00; }
        .group-match.group-5 { color: #c2185b; }
        .group-match.group-6 { color: #689f38; }
        .group-match.group-7 { color: #5e35b1; }
        .group-match.group-8 { color: #fbc02d; }
        .group-match.group-9 { color: #616161; }
        .status-bar {
            background: linear-gradient(to bottom, #e8e8e8, #d0d0d0);
            border-top: 1px solid #c0c0c0;
            padding: 4px 12px;
            font-size: 11px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 98;
        }
        
        /* History popup styles matching other tools */
        .history-container {
            position: relative;
        }
        .history-btn {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        .history-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .history-popup {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #a0a0a0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            width: 350px;
            max-height: 400px;
            z-index: 1000;
            display: none;
            margin-top: 2px;
        }
        .history-popup.show {
            display: block;
        }
        .history-tabs {
            display: flex;
            border-bottom: 1px solid #c0c0c0;
        }
        .history-tab {
            flex: 1;
            padding: 8px;
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            border: none;
            font-size: 11px;
            cursor: pointer;
            color: #666;
        }
        .history-tab.active {
            background: linear-gradient(to bottom, #ffffff, #f8f8f8);
            color: #333;
            border-bottom: 1px solid #ffffff;
        }
        .history-content {
            max-height: 350px;
            overflow-y: auto;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .history-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
        }
        .history-item:hover {
            background: #f8f8f8;
        }
        .history-item-time {
            color: #999;
            font-size: 9px;
        }
        .history-item-preview {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: #333;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Global History popup - positioned below button */
        .global-history-popup {
            position: fixed;
            top: 50px;
            right: 16px;
            background: white;
            border: 1px solid #a0a0a0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            width: 400px;
            max-height: 500px;
            z-index: 2000;
            display: none;
        }
        .global-history-popup.show {
            display: block;
        }
        .global-history-header {
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .global-history-content {
            max-height: 450px;
            overflow-y: auto;
        }
        .global-history-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
        }
        .global-history-item:hover {
            background: #f8f8f8;
        }
        .global-history-item-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }
        .global-history-item-meta {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .global-history-id-tool {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .global-history-tool-label {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        .global-history-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Regex Tester</h1>
        <div class="header-actions">
            <div class="font-controls">
                <label>Font:</label>
                <button id="fontDecreaseBtn" title="Decrease font size">‚àí</button>
                <button id="fontIncreaseBtn" title="Increase font size">+</button>
            </div>
            <button class="history-toggle-btn" id="historyToggleBtn">üìù History On</button>
            <div style="position: relative; display: inline-block;">
                <button class="global-history-btn" id="globalHistoryBtn">üìö Global History</button>
                <div class="global-history-popup" id="globalHistoryPopup">
                    <div class="global-history-header">
                        <span>Global History</span>
                        <button onclick="document.getElementById('globalHistoryPopup').classList.remove('show')" style="background: none; border: none; font-size: 14px; cursor: pointer;">‚úï</button>
                    </div>
                    <div class="global-history-content" id="globalHistoryContent">
                        <div id="globalHistoryList">
                            <div class="global-history-item">Loading global history...</div>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/">‚Üê Back to Tools</a>
        </div>
    </div>
    
    <div class="toolbar">
        <button class="primary" id="testBtn">Test Regex</button>
        <div class="separator"></div>
        <button id="clearBtn">Clear All</button>
        <button id="sampleBtn">Load Sample</button>
        <div class="separator"></div>
        <button id="copyMatchesBtn">Copy Matches</button>
        <div class="separator"></div>
        <div class="history-container">
            <button class="history-btn" id="historyBtn">üìã History</button>
            <div class="history-popup" id="historyPopup">
                <div class="history-tabs">
                    <button class="history-tab active" data-tab="history">History</button>
                    <button class="history-tab" data-tab="copy">Copy</button>
                </div>
                <div class="history-content" id="historyContent">
                    <div class="tab-content active" id="historyTab">
                        <div id="historyList">
                            <div class="history-item">No regex test history available</div>
                        </div>
                    </div>
                    <div class="tab-content" id="copyTab" style="display: none;">
                        <div class="history-item">Copy features coming soon</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="regex-section">
        <div class="regex-input-group">
            <span class="regex-delimiters">/</span>
            <input type="text" class="regex-input" id="regexInput" placeholder="Enter your regular expression...">
            <span class="regex-delimiters">/</span>
        </div>

        <div class="flags-section">
            <span style="color: #555; font-weight: bold;">Flags:</span>
            <div class="flag-group">
                <input type="checkbox" id="flagGlobal" checked>
                <label for="flagGlobal">g (global)</label>
            </div>
            <div class="flag-group">
                <input type="checkbox" id="flagIgnoreCase">
                <label for="flagIgnoreCase">i (ignore case)</label>
            </div>
            <div class="flag-group">
                <input type="checkbox" id="flagMultiline">
                <label for="flagMultiline">m (multiline)</label>
            </div>
            <div class="flag-group">
                <input type="checkbox" id="flagDotAll">
                <label for="flagDotAll">s (dotall)</label>
            </div>
            <div class="flag-group">
                <input type="checkbox" id="flagUnicode">
                <label for="flagUnicode">u (unicode)</label>
            </div>
        </div>

        <div id="regexError" class="regex-error"></div>

        <div class="quick-examples">
            <span style="color: #555;">Quick examples:</span>
            <button class="example-btn" data-pattern="\(([0-9]{3})\)[-. ]?([0-9]{3})[-. ]?([0-9]{4})" data-text="Call me at (555) 123-4567\nOr try 555-123-4567\nAlso 555.123.4567\nInvalid: 12-345-6789">USA Phone</button>
            <button class="example-btn" data-pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$" data-text="Password123!\nweakpass\nSTRONG456#\nAbc123\nMyP@ssw0rd" data-flags="gm">Strong Password</button>
            <button class="example-btn" data-pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" data-text="Contact: john@example.com\nsupport@company.org\nInvalid: not-email\nuser@test.co.uk">Email</button>
            <button class="example-btn" data-pattern="\d{4}-\d{2}-\d{2}" data-text="Today: 2024-03-15\nBirthday: 1990-12-25\nInvalid: 2024/03/15\nAlso: 2023-01-01">ISO Date</button>
            <button class="example-btn" data-pattern="\$([0-9]{1,3}(,[0-9]{3})*|[0-9]+)(\.[0-9]{2})?" data-text="Price: $19.99\nExpensive: $1,234.56\nCheap: $5\nCost: $12,345.00\nInvalid: 19.99">US Dollar</button>
            <button class="example-btn" data-pattern="^(?![-.])[A-Za-z0-9](?:[A-Za-z0-9._%+-]{0,62}(?<!\.))?(?<!\.)@(?=[A-Za-z0-9])[A-Za-z0-9](?:[A-Za-z0-9.-]{0,251}(?<!\.))?(?<!\.)(\.[A-Za-z]{2,})$|^(?:[1-9]\d{0,2}\.){3}(?:[1-9]\d{0,2})$|^(?:[0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4}$" data-text="# Valid Emails\njohn.doe@example.com\njane_doe+123@subdomain.test.org\na@domain.co\nlong.local.part12345678901234567890123456789012345678901234567890123@domain.travel\nvalid-email@domain.io\n\n# Invalid Emails\n.invalid@domain.com\ndouble..dot@domain.com\nlocal@domain..com\n@missing.local.com\ntest@-bad.com\ntest@domain.c\nspace in@domain.com\ntoolong.local.part123456789012345678901234567890123456789012345678901234@domain.com\nemail@domain\n\n# Valid IPv4\n192.168.0.1\n1.2.3.4\n255.255.255.255\n\n# Invalid IPv4\n0.0.0.0\n256.1.2.3\n1.2.3\n1.2.3.4.5\n192.168.001.1\n\n# Valid IPv6\n2001:0db8:85a3:0000:0000:8a2e:0370:7334\nffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff\n1:2:3:4:5:6:7:8\n\n# Invalid IPv6\n2001:0db8:85a3:0000:0000:8a2e:0370\n2001:0db8:85a3:0000:0000:8a2e:0370:7334:\ng001:0db8:85a3:0000:0000:8a2e:0370:7334\n2001:0db8:85a3:0000:0000:8a2e:0370:7334:extra\n2001:0db8::7334" data-flags="gm">Advanced Email/IP</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel-header">
                Test String
                <span class="match-indicator" id="matchCount">NO MATCHES</span>
            </div>
            <div class="panel-content">
                <textarea class="test-text-area" id="testText" placeholder="Enter your test string here..."></textarea>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                Highlighted Matches
                <button class="example-btn" id="toggleMatchesBtn">Show Details</button>
            </div>
            <div class="panel-content">
                <div class="highlighted-text" id="highlightedText">
                    <div class="regex-no-match">Enter a regex pattern and test string to see matches highlighted</div>
                </div>
            </div>
            <div class="matches-panel" id="matchesPanel">
                <div class="matches-header">
                    <span>Match Details</span>
                    <span id="matchesCount">0 matches</span>
                </div>
                <div id="matchesList"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="statusText">Ready - Enter a regex pattern and test string</div>
        <div id="regexInfo">Pattern: None | Test length: 0</div>
    </div>

    <script>
        // Enhanced Regex Tester Tool - Modular JavaScript Implementation
        document.addEventListener('DOMContentLoaded', function() {
            window.regexTester = new RegexTester();
        });

        class RegexTester {
            constructor() {
                this.toolName = 'regex-tester';
                this.historyEnabled = localStorage.getItem(`${this.toolName}-historyEnabled`) !== 'false';
                this.lastInputData = null;
                this.currentMatches = [];
                this.activeMatchIndex = -1;
                this.matchesPanelVisible = false;
                this.fontSize = parseInt(localStorage.getItem(`${this.toolName}-fontSize`) || '13');
                
                this.elements = {
                    // Input elements
                    regexInput: document.getElementById('regexInput'),
                    testText: document.getElementById('testText'),
                    
                    // Flag checkboxes
                    flagGlobal: document.getElementById('flagGlobal'),
                    flagIgnoreCase: document.getElementById('flagIgnoreCase'),
                    flagMultiline: document.getElementById('flagMultiline'),
                    flagDotAll: document.getElementById('flagDotAll'),
                    flagUnicode: document.getElementById('flagUnicode'),
                    
                    // Display elements
                    highlightedText: document.getElementById('highlightedText'),
                    matchCount: document.getElementById('matchCount'),
                    matchesCount: document.getElementById('matchesCount'),
                    matchesList: document.getElementById('matchesList'),
                    matchesPanel: document.getElementById('matchesPanel'),
                    regexError: document.getElementById('regexError'),
                    statusText: document.getElementById('statusText'),
                    regexInfo: document.getElementById('regexInfo'),
                    
                    // Buttons
                    testBtn: document.getElementById('testBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    sampleBtn: document.getElementById('sampleBtn'),
                    copyMatchesBtn: document.getElementById('copyMatchesBtn'),
                    toggleMatchesBtn: document.getElementById('toggleMatchesBtn'),
                    
                    // History
                    historyBtn: document.getElementById('historyBtn'),
                    historyToggleBtn: document.getElementById('historyToggleBtn'),
                    historyPopup: document.getElementById('historyPopup'),
                    historyList: document.getElementById('historyList'),
                    
                    // Global History
                    globalHistoryBtn: document.getElementById('globalHistoryBtn'),
                    globalHistoryPopup: document.getElementById('globalHistoryPopup'),
                    globalHistoryList: document.getElementById('globalHistoryList'),
                    
                    // Font controls
                    fontIncreaseBtn: document.getElementById('fontIncreaseBtn'),
                    fontDecreaseBtn: document.getElementById('fontDecreaseBtn')
                };
                
                this.attachEventListeners();
                this.loadHistory();
                this.initializeHistoryToggle();
                this.applyFontSize();
                this.updateStatus('Ready - Enter a regex pattern and test string');
            }

            // Event Listeners
            attachEventListeners() {
                // Main functionality
                this.elements.testBtn.addEventListener('click', () => this.testRegex());
                this.elements.clearBtn.addEventListener('click', () => this.clearAll());
                this.elements.sampleBtn.addEventListener('click', () => this.loadSampleData());
                this.elements.copyMatchesBtn.addEventListener('click', () => this.copyMatches());
                this.elements.toggleMatchesBtn.addEventListener('click', () => this.toggleMatchesPanel());
                
                // Auto-test on input changes
                this.elements.regexInput.addEventListener('input', () => this.debounceTest());
                this.elements.testText.addEventListener('input', () => this.debounceTest());
                
                // Flag changes
                [this.elements.flagGlobal, this.elements.flagIgnoreCase, this.elements.flagMultiline, 
                 this.elements.flagDotAll, this.elements.flagUnicode].forEach(flag => {
                    flag.addEventListener('change', () => this.debounceTest());
                });
                
                // Example buttons
                document.querySelectorAll('.example-btn[data-pattern]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.loadExample(e));
                });
                
                // History functionality
                this.elements.historyBtn.addEventListener('click', () => this.toggleHistory());
                this.elements.historyToggleBtn.addEventListener('click', () => this.toggleHistoryEnabled());
                this.elements.globalHistoryBtn.addEventListener('click', () => this.toggleGlobalHistory());
                
                // Font size controls
                this.elements.fontIncreaseBtn.addEventListener('click', () => this.increaseFontSize());
                this.elements.fontDecreaseBtn.addEventListener('click', () => this.decreaseFontSize());
                
                // History tabs
                document.querySelectorAll('.history-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchHistoryTab(e));
                });
                
                // Outside click handler
                document.addEventListener('click', (e) => this.handleOutsideClick(e));
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            }

            // Debounced testing for live updates
            debounceTest() {
                clearTimeout(this.testTimeout);
                this.testTimeout = setTimeout(() => {
                    if (this.elements.regexInput.value.trim() && this.elements.testText.value.trim()) {
                        this.testRegex();
                    }
                }, 300);
            }

            // Core Regex Testing Logic
            testRegex() {
                const pattern = this.elements.regexInput.value.trim();
                const testText = this.elements.testText.value;
                
                this.clearError();
                
                if (!pattern) {
                    this.showNoPattern();
                    return;
                }
                
                // Handle empty pattern case
                if (pattern === '') {
                    this.showError('Empty pattern not allowed');
                    return;
                }
                
                if (!testText) {
                    this.showNoText();
                    return;
                }
                
                try {
                    const flags = this.getRegexFlags();
                    const regex = new RegExp(pattern, flags);
                    this.elements.regexInput.className = 'regex-input valid';
                    
                    const matches = this.findMatches(regex, testText, flags, pattern);
                    this.currentMatches = matches;
                    
                    this.displayResults(matches);
                    this.updateMatchCount(matches.length);
                    this.updateStatus(matches.length > 0 ? 
                        `Found ${matches.length} match${matches.length > 1 ? 'es' : ''}` : 
                        'No matches found');
                    this.updateRegexInfo(pattern, testText.length, flags);
                    
                    // Save to history if enabled
                    this.saveToHistoryIfChanged(pattern, testText, flags, 'test');
                    
                } catch (error) {
                    this.showError(error.message);
                }
            }

            // Regex Matching Logic
            findMatches(regex, text, flags, pattern) {
                const matches = [];
                let match;

                // Standard matching logic
                if (flags.includes('g')) {
                    while ((match = regex.exec(text)) !== null) {
                        matches.push({
                            match: match[0],
                            index: match.index,
                            endIndex: match.index + match[0].length,
                            groups: match.slice(1),
                            fullMatch: match
                        });
                        
                        // Prevent infinite loop on zero-length matches
                        if (match.index === regex.lastIndex) {
                            regex.lastIndex++;
                        }
                    }
                } else {
                    match = regex.exec(text);
                    if (match) {
                        matches.push({
                            match: match[0],
                            index: match.index,
                            endIndex: match.index + match[0].length,
                            groups: match.slice(1),
                            fullMatch: match
                        });
                    }
                }
                
                return matches;
            }

            // Display and Highlighting Logic
            displayResults(matches) {
                if (matches.length === 0) {
                    this.showNoMatches();
                    return;
                }
                
                const text = this.elements.testText.value;
                this.highlightMatches(text, matches);
                this.displayMatchDetails(matches);
            }

            highlightMatches(text, matches) {
                let highlightedHtml = '';
                let lastIndex = 0;
                
                // Sort matches by index to handle overlapping correctly
                const sortedMatches = [...matches].sort((a, b) => a.index - b.index);
                
                sortedMatches.forEach((match, matchIndex) => {
                    // Add text before match
                    highlightedHtml += this.escapeHtml(text.slice(lastIndex, match.index));
                    
                    // Add highlighted match with groups
                    highlightedHtml += this.createMatchHtml(match, matchIndex);
                    
                    lastIndex = match.endIndex;
                });
                
                // Add remaining text
                highlightedHtml += this.escapeHtml(text.slice(lastIndex));
                
                this.elements.highlightedText.innerHTML = highlightedHtml;
            }

            createMatchHtml(match, matchIndex) {
                const groupInfo = match.groups.length > 0 ? 
                    ` (${match.groups.length} group${match.groups.length > 1 ? 's' : ''})` : '';
                    
                let html = `<span class="regex-match group-0" data-match-index="${matchIndex}" title="Full match: ${this.escapeHtml(match.match)}${groupInfo}">`;
                
                // For now, highlight the entire match with group-0 styling
                // Future enhancement: implement sophisticated group parsing for individual group highlighting
                html += this.escapeHtml(match.match);
                
                html += '</span>';
                return html;
            }

            displayMatchDetails(matches) {
                let detailsHtml = '';
                
                matches.forEach((match, index) => {
                    detailsHtml += `
                        <div class="match-item" data-match-index="${index}">
                            <span class="match-index">#${index + 1}</span>
                            <span class="match-text">${this.escapeHtml(match.match)}</span>
                            <span class="match-position">at ${match.index}-${match.endIndex}</span>
                            ${match.groups.length > 0 ? this.createGroupsHtml(match.groups) : ''}
                        </div>
                    `;
                });
                
                this.elements.matchesList.innerHTML = detailsHtml;
                this.elements.matchesCount.textContent = `${matches.length} match${matches.length > 1 ? 'es' : ''}`;
                
                // Add click handlers for match items
                document.querySelectorAll('.match-item').forEach(item => {
                    item.addEventListener('click', (e) => this.highlightMatch(e));
                });
            }

            createGroupsHtml(groups) {
                if (groups.length === 0) return '';
                
                let groupsHtml = '<div class="group-matches">';
                groups.forEach((group, index) => {
                    if (group !== undefined) {
                        groupsHtml += `<span class="group-match group-${(index % 9) + 1}">$${index + 1}: "${this.escapeHtml(group)}"</span>`;
                    }
                });
                groupsHtml += '</div>';
                
                return groupsHtml;
            }

            // UI State Management
            showNoPattern() {
                this.elements.highlightedText.innerHTML = '<div class="regex-no-match">Enter a regex pattern to test</div>';
                this.updateMatchCount(0, 'NO PATTERN');
                this.updateStatus('Enter a regex pattern');
            }

            showNoText() {
                this.elements.highlightedText.innerHTML = '<div class="regex-no-match">Enter test string to match against</div>';
                this.updateMatchCount(0, 'NO TEXT');
                this.updateStatus('Enter test string');
            }

            showNoMatches() {
                this.elements.highlightedText.innerHTML = '<div class="regex-no-match">No matches found</div>';
                this.elements.matchesList.innerHTML = '<div class="match-item">No matches to display</div>';
                this.elements.matchesCount.textContent = '0 matches';
            }

            showError(message) {
                this.elements.regexInput.className = 'regex-input error';
                this.elements.regexError.textContent = `Error: ${message}`;
                this.elements.highlightedText.innerHTML = '<div class="regex-no-match">Invalid regex pattern</div>';
                this.updateMatchCount(0, 'ERROR');
                this.updateStatus(`Regex error: ${message}`);
            }

            clearError() {
                this.elements.regexError.textContent = '';
                this.elements.regexInput.className = 'regex-input';
            }

            updateMatchCount(count, customText = null) {
                const text = customText || (count === 0 ? 'NO MATCHES' : `${count} MATCH${count > 1 ? 'ES' : ''}`);
                this.elements.matchCount.textContent = text;
                this.elements.matchCount.className = `match-indicator ${count > 0 ? 'matches' : 'no-matches'}`;
            }

            updateStatus(message) {
                this.elements.statusText.textContent = message;
            }

            updateRegexInfo(pattern, textLength, flags) {
                this.elements.regexInfo.textContent = `Pattern: /${pattern}/${flags} | Test length: ${textLength}`;
            }

            // Utility Functions
            getRegexFlags() {
                let flags = '';
                if (this.elements.flagGlobal.checked) flags += 'g';
                if (this.elements.flagIgnoreCase.checked) flags += 'i';
                if (this.elements.flagMultiline.checked) flags += 'm';
                if (this.elements.flagDotAll.checked) flags += 's';
                if (this.elements.flagUnicode.checked) flags += 'u';
                return flags;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // UI Actions
            clearAll() {
                this.elements.regexInput.value = '';
                this.elements.testText.value = '';
                this.elements.highlightedText.innerHTML = '<div class="regex-no-match">Enter a regex pattern and test string to see matches highlighted</div>';
                this.elements.matchesList.innerHTML = '';
                this.updateMatchCount(0);
                this.clearError();
                this.updateStatus('Ready - Enter a regex pattern and test string');
                this.updateRegexInfo('None', 0, '');
                this.currentMatches = [];
            }

            loadSampleData() {
                this.elements.regexInput.value = '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}';
                this.elements.testText.value = 'Contact us at support@example.com or sales@company.org\nInvalid: not-an-email\nAlso try: user@test.co.uk';
                this.elements.flagGlobal.checked = true;
                this.testRegex();
            }

            loadExample(event) {
                const btn = event.target;
                const pattern = btn.dataset.pattern;
                const text = btn.dataset.text;
                const flags = btn.dataset.flags;
                
                this.elements.regexInput.value = pattern;
                // Convert literal \n to actual newlines
                this.elements.testText.value = text.replace(/\\n/g, '\n');
                
                // Set flags if specified
                if (flags) {
                    this.elements.flagGlobal.checked = flags.includes('g');
                    this.elements.flagIgnoreCase.checked = flags.includes('i');
                    this.elements.flagMultiline.checked = flags.includes('m');
                    this.elements.flagDotAll.checked = flags.includes('s');
                    this.elements.flagUnicode.checked = flags.includes('u');
                } else {
                    // Default: only global flag
                    this.elements.flagGlobal.checked = true;
                    this.elements.flagIgnoreCase.checked = false;
                    this.elements.flagMultiline.checked = false;
                    this.elements.flagDotAll.checked = false;
                    this.elements.flagUnicode.checked = false;
                }
                
                this.testRegex();
            }

            async copyMatches() {
                if (this.currentMatches.length === 0) {
                    this.updateStatus('No matches to copy');
                    return;
                }
                
                const matchesText = this.currentMatches.map((match, index) => 
                    `Match ${index + 1}: "${match.match}" at ${match.index}-${match.endIndex}${ 
                        match.groups.length > 0 ? 
                        '\n  Groups: ' + match.groups.map((g, i) => `$${i+1}: "${g}"`).join(', ') : 
                        ''
                    }`
                ).join('\n');
                
                try {
                    await navigator.clipboard.writeText(matchesText);
                    this.updateStatus('Matches copied to clipboard');
                } catch (err) {
                    console.error('Failed to copy matches: ', err);
                    this.updateStatus('Failed to copy matches');
                }
            }

            toggleMatchesPanel() {
                this.matchesPanelVisible = !this.matchesPanelVisible;
                
                if (this.matchesPanelVisible) {
                    this.elements.matchesPanel.classList.add('show');
                    this.elements.toggleMatchesBtn.textContent = 'Hide Details';
                } else {
                    this.elements.matchesPanel.classList.remove('show');
                    this.elements.toggleMatchesBtn.textContent = 'Show Details';
                }
            }

            highlightMatch(event) {
                const matchIndex = parseInt(event.currentTarget.dataset.matchIndex);
                
                // Remove previous active states
                document.querySelectorAll('.match-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active state to clicked item
                event.currentTarget.classList.add('active');
                
                // Scroll to match in highlighted text (future enhancement)
                this.activeMatchIndex = matchIndex;
            }

            handleKeydown(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            this.testRegex();
                            break;
                    }
                }
            }

            // History functionality (matching other tools)
            async saveToHistoryIfChanged(pattern, testText, flags, operation) {
                if (!this.historyEnabled) {
                    return;
                }

                const currentData = JSON.stringify({ pattern, testText, flags });
                if (currentData !== this.lastInputData) {
                    this.lastInputData = currentData;
                    await this.saveToHistory({ pattern, testText, flags }, operation);
                }
            }

            async saveToHistory(data, operation) {
                if (!this.historyEnabled) return;

                try {
                    const response = await fetch(`/api/history/${this.toolName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: JSON.stringify(data),
                            operation: operation
                        })
                    });

                    if (response.ok) {
                        this.loadHistory();
                    }
                } catch (error) {
                    console.error('Error saving history:', error);
                }
            }

            async loadHistory() {
                try {
                    const response = await fetch(`/api/history/${this.toolName}?limit=20`);
                    const result = await response.json();
                    
                    this.displayHistory(result.history || []);
                } catch (error) {
                    console.error('Error loading history:', error);
                    this.elements.historyList.innerHTML = '<div class="history-item">Failed to load history</div>';
                }
            }

            displayHistory(history) {
                if (history.length === 0) {
                    this.elements.historyList.innerHTML = '<div class="history-item">No regex test history available</div>';
                    return;
                }

                this.elements.historyList.innerHTML = history.map(entry => {
                    try {
                        const time = new Date(entry.timestamp).toLocaleString();
                        // Use the preview field directly (it's already a formatted string from the backend)
                        const preview = entry.preview || 'No preview available';
                        
                        return `
                            <div class="history-item" onclick="regexTester.loadHistoryEntry('${entry.id}')">
                                <div class="history-item-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                                    <div class="history-item-content" style="flex: 1; display: flex; align-items: flex-start; gap: 6px;">
                                        <input type="checkbox" class="history-checkbox" data-id="${entry.id}" onclick="regexTester.handleHistorySelection('${entry.id}', event.target.checked); event.stopPropagation();" style="margin-top: 2px; cursor: pointer;">
                                        <div class="history-meta" style="display: flex; flex-direction: column; gap: 2px;">
                                            <span class="history-id" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 9px; color: #666; font-weight: bold;">ID: ${entry.id}</span>
                                            <div class="history-item-time" style="color: #999; font-size: 10px;">${time} - ${entry.operation || 'test'}</div>
                                        </div>
                                    </div>
                                    <button class="history-delete-btn" onclick="regexTester.deleteHistoryItem('${entry.id}'); event.stopPropagation();" style="background: #ff4444; color: white; border: none; border-radius: 2px; padding: 2px 6px; font-size: 10px; cursor: pointer; margin-left: 8px; opacity: 0.7; transition: opacity 0.2s;">√ó</button>
                                </div>
                                <div class="history-item-preview" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 10px; color: #333; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-height: 40px; line-height: 1.3;">${preview}</div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error displaying history entry:', error, entry);
                        return '<div class="history-item">Error loading entry</div>';
                    }
                }).join('');
            }

            async loadHistoryEntry(entryId) {
                try {
                    const response = await fetch(`/api/history/${this.toolName}/${entryId}`);
                    const entry = await response.json();
                    
                    if (entry && entry.data) {
                        const data = JSON.parse(entry.data);
                        
                        this.elements.regexInput.value = data.pattern || '';
                        // Convert literal \n to actual newlines (same as loadExample)
                        this.elements.testText.value = (data.testText || '').replace(/\\n/g, '\n');
                        
                        // Set flags
                        this.elements.flagGlobal.checked = (data.flags || '').includes('g');
                        this.elements.flagIgnoreCase.checked = (data.flags || '').includes('i');
                        this.elements.flagMultiline.checked = (data.flags || '').includes('m');
                        this.elements.flagDotAll.checked = (data.flags || '').includes('s');
                        this.elements.flagUnicode.checked = (data.flags || '').includes('u');
                        
                        this.elements.historyPopup.classList.remove('show');
                        this.testRegex();
                        this.updateStatus('History entry loaded');
                    }
                } catch (error) {
                    console.error('Error loading history entry:', error);
                    this.updateStatus('Failed to load history entry');
                }
            }

            toggleHistory() {
                this.elements.historyPopup.classList.toggle('show');
                if (this.elements.historyPopup.classList.contains('show')) {
                    this.loadHistory();
                }
            }

            toggleHistoryEnabled() {
                this.historyEnabled = !this.historyEnabled;
                localStorage.setItem(`${this.toolName}-historyEnabled`, this.historyEnabled.toString());
                
                const btn = this.elements.historyToggleBtn;
                if (this.historyEnabled) {
                    btn.textContent = 'üìù History On';
                    btn.classList.remove('disabled');
                    btn.title = 'History Enabled - Click to Disable';
                    this.updateStatus('History enabled');
                } else {
                    btn.textContent = 'üìù History Off';
                    btn.classList.add('disabled');
                    btn.title = 'History Disabled - Click to Enable';
                    this.updateStatus('History disabled - tests will not be saved');
                }
            }

            initializeHistoryToggle() {
                const btn = this.elements.historyToggleBtn;
                if (this.historyEnabled) {
                    btn.textContent = 'üìù History On';
                    btn.classList.remove('disabled');
                    btn.title = 'History Enabled - Click to Disable';
                } else {
                    btn.textContent = 'üìù History Off';
                    btn.classList.add('disabled');
                    btn.title = 'History Disabled - Click to Enable';
                }
            }

            async loadGlobalHistory() {
                try {
                    const response = await fetch(`/api/global-history?limit=50`);
                    const result = await response.json();
                    
                    this.displayGlobalHistory(result.history || []);
                } catch (error) {
                    console.error('Error loading global history:', error);
                    this.elements.globalHistoryList.innerHTML = '<div class="global-history-item">Failed to load global history</div>';
                }
            }

            displayGlobalHistory(history) {
                if (history.length === 0) {
                    this.elements.globalHistoryList.innerHTML = '<div class="global-history-item">No global history available</div>';
                    return;
                }

                this.elements.globalHistoryList.innerHTML = history.map(entry => {
                    const time = new Date(entry.timestamp).toLocaleString();
                    const toolColor = this.getToolColor(entry.tool_name);
                    
                    return `
                        <div class="global-history-item" onclick="regexTester.loadGlobalHistoryEntry('${entry.id}', '${entry.tool_name}')">
                            <div class="global-history-item-header">
                                <input type="checkbox" class="global-history-checkbox" onclick="regexTester.handleHistorySelection('${entry.id}', event.target.checked); event.stopPropagation();">
                                <div class="global-history-item-meta">
                                    <div class="global-history-id-tool">
                                        <span style="font-family: 'Consolas', monospace; font-size: 9px; color: #666;">#${entry.id}</span>
                                        <span class="global-history-tool-label" style="background: ${toolColor};">${entry.tool_name}</span>
                                    </div>
                                    <div style="font-size: 9px; color: #999;">${time}</div>
                                </div>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">${entry.operation}</div>
                        </div>
                    `;
                }).join('');
            }

            async loadGlobalHistoryEntry(entryId, toolName) {
                if (toolName !== this.toolName) {
                    this.updateStatus('Cannot load entry from different tool');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/global-history/${entryId}`);
                    const entry = await response.json();
                    
                    if (entry && entry.data) {
                        const data = JSON.parse(entry.data);
                        
                        this.elements.regexInput.value = data.pattern || '';
                        // Convert literal \n to actual newlines (same as loadExample)
                        this.elements.testText.value = (data.testText || '').replace(/\\n/g, '\n');
                        
                        // Set flags
                        this.elements.flagGlobal.checked = (data.flags || '').includes('g');
                        this.elements.flagIgnoreCase.checked = (data.flags || '').includes('i');
                        this.elements.flagMultiline.checked = (data.flags || '').includes('m');
                        this.elements.flagDotAll.checked = (data.flags || '').includes('s');
                        this.elements.flagUnicode.checked = (data.flags || '').includes('u');
                        
                        this.elements.globalHistoryPopup.classList.remove('show');
                        this.testRegex();
                        this.updateStatus('Global history entry loaded');
                    }
                } catch (error) {
                    console.error('Error loading global history entry:', error);
                    this.updateStatus('Failed to load global history entry');
                }
            }

            toggleGlobalHistory() {
                this.elements.globalHistoryPopup.classList.toggle('show');
                if (this.elements.globalHistoryPopup.classList.contains('show')) {
                    this.loadGlobalHistory();
                }
            }

            getToolColor(toolName) {
                const colors = {
                    'json-formatter': '#2196F3',
                    'json-yaml-xml-converter': '#4CAF50', 
                    'text-diff': '#FF5722',
                    'regex-tester': '#9C27B0',
                    'base64-encoder-decoder': '#FF9800',
                    'url-encoder-decoder': '#607D8B',
                    'hash-generator': '#F44336',
                    'qr-code-generator': '#795548'
                };
                return colors[toolName] || '#757575';
            }

            async deleteHistoryItem(entryId) {
                try {
                    const response = await fetch(`/api/history/${this.toolName}/${entryId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.updateStatus('History item deleted');
                        this.loadHistory();
                        this.loadGlobalHistory();
                    } else {
                        this.updateStatus('Failed to delete history item');
                    }
                } catch (error) {
                    console.error('Error deleting history item:', error);
                    this.updateStatus('Failed to delete history item');
                }
            }

            async deleteGlobalHistoryItem(entryId) {
                try {
                    const response = await fetch(`/api/global-history/${entryId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.updateStatus('History item deleted');
                        this.loadHistory();
                        this.loadGlobalHistory();
                    } else {
                        this.updateStatus('Failed to delete history item');
                    }
                } catch (error) {
                    console.error('Error deleting global history item:', error);
                    this.updateStatus('Failed to delete history item');
                }
            }

            switchHistoryTab(event) {
                const clickedTab = event.target;
                const targetTab = clickedTab.dataset.tab;
                
                document.querySelectorAll('.history-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });
                
                clickedTab.classList.add('active');
                const targetContent = document.getElementById(targetTab + 'Tab');
                if (targetContent) {
                    targetContent.classList.add('active');
                    targetContent.style.display = 'block';
                }
            }

            handleHistorySelection(entryId, isSelected) {
                // Implementation for history selection (similar to other tools)
                console.log('History selection:', entryId, isSelected);
            }

            handleOutsideClick(event) {
                const historyPopup = this.elements.historyPopup;
                const historyBtn = this.elements.historyBtn;
                const globalHistoryPopup = this.elements.globalHistoryPopup;
                const globalHistoryBtn = this.elements.globalHistoryBtn;
                
                if (historyPopup && historyPopup.classList.contains('show') &&
                    !historyPopup.contains(event.target) && !historyBtn.contains(event.target)) {
                    historyPopup.classList.remove('show');
                }
                
                if (globalHistoryPopup && globalHistoryPopup.classList.contains('show') &&
                    !globalHistoryPopup.contains(event.target) && !globalHistoryBtn.contains(event.target)) {
                    globalHistoryPopup.classList.remove('show');
                }
            }
            
            // Font size methods
            increaseFontSize() {
                if (this.fontSize < 24) {
                    this.fontSize += 1;
                    this.applyFontSize();
                    this.saveFontSize();
                }
            }
            
            decreaseFontSize() {
                if (this.fontSize > 8) {
                    this.fontSize -= 1;
                    this.applyFontSize();
                    this.saveFontSize();
                }
            }
            
            applyFontSize() {
                this.elements.regexInput.style.fontSize = `${this.fontSize}px`;
                this.elements.testText.style.fontSize = `${this.fontSize}px`;
                this.elements.highlightedText.style.fontSize = `${this.fontSize}px`;
                this.elements.matchesList.style.fontSize = `${this.fontSize}px`;
            }
            
            saveFontSize() {
                localStorage.setItem(`${this.toolName}-fontSize`, this.fontSize.toString());
            }
        }
    </script>
</body>
</html>