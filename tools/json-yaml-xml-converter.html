<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-YAML-XML Converter - Helpful Tools v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            font-size: 13px;
        }
        .header {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 8px 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        .header a {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
            text-decoration: none;
        }
        .header a:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .toolbar {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        .toolbar button {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        .toolbar button:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .toolbar button:active {
            background: linear-gradient(to bottom, #e0e0e0, #f0f0f0);
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2);
        }
        .toolbar button.json-convert {
            background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
            border-color: #4a90e2;
            color: #1565c0;
        }
        .toolbar button.json-convert:hover {
            background: linear-gradient(to bottom, #f0f8ff, #d1e7ff);
        }
        .toolbar button.yaml-convert {
            background: linear-gradient(to bottom, #fff3e0, #ffcc95);
            border-color: #ff6b35;
            color: #d84315;
        }
        .toolbar button.yaml-convert:hover {
            background: linear-gradient(to bottom, #fff8f0, #ffd6b8);
        }
        .toolbar button.xml-convert {
            background: linear-gradient(to bottom, #e8f5e8, #a5d6a7);
            border-color: #28a745;
            color: #1b5e20;
        }
        .toolbar button.xml-convert:hover {
            background: linear-gradient(to bottom, #f1f8e9, #c8e6c9);
        }
        .toolbar button.primary {
            background: linear-gradient(to bottom, #4a90e2, #357abd);
            color: white;
            border: 1px solid #2968a3;
        }
        .toolbar button.primary:hover {
            background: linear-gradient(to bottom, #5ba0f2, #4a90e2);
        }
        .separator {
            width: 1px;
            height: 16px;
            background: #c0c0c0;
            margin: 0 2px;
        }
        .history-container {
            position: relative;
        }
        .history-btn {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        .history-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        .history-popup {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #a0a0a0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            width: 300px;
            max-height: 400px;
            z-index: 1000;
            display: none;
            margin-top: 2px;
        }
        .history-popup.show {
            display: block;
        }
        .history-tabs {
            display: flex;
            border-bottom: 1px solid #c0c0c0;
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
        }
        .history-tab {
            flex: 1;
            padding: 4px 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            color: #555;
        }
        .history-tab.active {
            background: white;
            border-bottom: 1px solid white;
            color: #333;
        }
        .history-content {
            max-height: 350px;
            overflow-y: auto;
        }
        .history-item {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
        }
        .history-item:hover {
            background: #f8f8f8;
        }
        .history-date {
            color: #666;
            font-size: 10px;
            margin-bottom: 2px;
        }
        .history-preview {
            color: #333;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .main-container {
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }
        .panels-container {
            flex: 1;
            display: flex;
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #c0c0c0;
        }
        .panel:last-child {
            border-right: none;
        }
        .panel-header {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            border-bottom: 1px solid #c0c0c0;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-content {
            flex: 1;
            position: relative;
            background: #ffffff;
        }
        .panel-textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            resize: none;
            background: white;
        }
        .panel-textarea::placeholder {
            color: #999;
            font-style: italic;
        }
        .formatted-output {
            width: 100%;
            height: 100%;
            padding: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: white;
            overflow: auto;
            white-space: pre;
            border: none;
        }
        .error-display {
            background: #fff0f0;
            color: #cc0000;
            padding: 8px;
            border-left: 4px solid #cc0000;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
        .status-bar {
            background: linear-gradient(to bottom, #e8e8e8, #d8d8d8);
            border-top: 1px solid #c0c0c0;
            padding: 4px 12px;
            font-size: 11px;
            color: #555;
            display: flex;
            gap: 16px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .copy-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 11px;
            padding: 2px 4px;
        }
        .copy-btn:hover {
            color: #333;
            background: rgba(0,0,0,0.05);
        }
        
        /* Format controls */
        .format-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
        }
        .format-controls label {
            color: #555;
        }
        .format-controls select {
            font-size: 11px;
            padding: 2px 4px;
            border: 1px solid #a0a0a0;
            background: white;
        }
        
        /* Format indicators */
        .format-indicator {
            background: #4a90e2;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .format-indicator.json {
            background: #4a90e2;
        }
        .format-indicator.yaml {
            background: #ff6b35;
        }
        .format-indicator.xml {
            background: #28a745;
        }
        .format-indicator.unknown {
            background: #888;
        }
        
        /* Syntax highlighting */
        .json-string { color: #008000; }
        .json-number { color: #0000ff; }
        .json-boolean { color: #800080; }
        .json-null { color: #808080; }
        .json-key { color: #000080; font-weight: bold; }
        .json-punctuation { color: #000000; }
        
        .yaml-string { color: #008000; }
        .yaml-number { color: #0000ff; }
        .yaml-boolean { color: #800080; }
        .yaml-null { color: #808080; }
        .yaml-key { color: #000080; font-weight: bold; }
        .yaml-comment { color: #888888; font-style: italic; }
        .yaml-punctuation { color: #000000; }
        
        .xml-tag { color: #800000; font-weight: bold; }
        .xml-attribute { color: #ff8000; }
        .xml-value { color: #0000ff; }
        .xml-text { color: #000000; }
        .xml-comment { color: #888888; font-style: italic; }
        .xml-declaration { color: #800080; }
        
        /* Header actions styling */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .global-history-btn {
            background: linear-gradient(to bottom, #f8f8f8, #e0e0e0);
            border: 1px solid #a0a0a0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #333;
        }
        
        .global-history-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8e8e8);
        }
        
        .history-toggle-btn {
            background: linear-gradient(to bottom, #f0f8ff, #d1e7ff);
            border: 1px solid #4a90e2;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
            color: #1565c0;
        }
        
        .history-toggle-btn:hover {
            background: linear-gradient(to bottom, #ffffff, #e8f4fd);
        }
        
        .history-toggle-btn.disabled {
            background: linear-gradient(to bottom, #fff0f0, #fdd8d8);
            border-color: #dc3545;
            color: #c82333;
        }
        
        .history-toggle-btn.disabled:hover {
            background: linear-gradient(to bottom, #fff5f5, #ffe0e0);
        }
        
        /* Global history popup */
        .global-history-popup {
            position: fixed;
            top: 50px;
            right: 16px;
            background: white;
            border: 1px solid #a0a0a0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            width: 400px;
            max-height: 500px;
            z-index: 2000;
            display: none;
            margin-top: 2px;
        }
        
        .global-history-popup.show {
            display: block;
        }
        
        .global-history-header {
            background: linear-gradient(to bottom, #f8f8f8, #e8e8e8);
            border-bottom: 1px solid #c0c0c0;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .global-history-content {
            max-height: 450px;
            overflow-y: auto;
        }
        
        .global-history-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            font-size: 11px;
        }
        
        .global-history-item:hover {
            background: #f8f8f8;
        }
        
        .global-history-item-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .global-history-item-meta {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .global-history-id-tool {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .global-history-tool-label {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .global-history-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
        
        .history-delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 2px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .history-delete-btn:hover {
            opacity: 1;
            background: #cc3333;
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        
        .history-item-content {
            flex: 1;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }
        
        .history-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .history-id {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 9px;
            color: #666;
            font-weight: bold;
        }
        
        .history-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>JSON-YAML-XML Converter</h1>
        <div class="header-actions">
            <button class="history-toggle-btn" id="historyToggleBtn">üìù History On</button>
            <button class="global-history-btn" id="globalHistoryBtn">üìö Global History</button>
            <a href="/">‚Üê Back to Tools</a>
        </div>
    </div>
    
    <div class="toolbar">
        <button class="json-convert" id="convertToJson">JSON</button>
        <button class="yaml-convert" id="convertToYaml">YAML</button>
        <button class="xml-convert" id="convertToXml">XML</button>
        <div class="separator"></div>
        <button id="formatBtn">Format</button>
        <button id="swapBtn">Swap</button>
        <div class="separator"></div>
        <button id="clearBtn">Clear</button>
        <button id="copyBtn">Copy Output</button>
        <div class="separator"></div>
        <button id="jsonExampleBtn">JSON Example</button>
        <button id="yamlExampleBtn">YAML Example</button>
        <div class="separator"></div>
        <div class="format-controls">
            <label>YAML Indent:</label>
            <select id="yamlIndent">
                <option value="2" selected>2 spaces</option>
                <option value="4">4 spaces</option>
                <option value="6">6 spaces</option>
            </select>
        </div>
        <div class="separator"></div>
        <div class="history-container">
            <button class="history-btn" id="historyBtn">üìã History</button>
            <div class="history-popup" id="historyPopup">
                <div class="history-tabs">
                    <button class="history-tab active" data-tab="history">History</button>
                    <button class="history-tab" data-tab="copy">Copy</button>
                </div>
                <div class="history-content" id="historyContent">
                    <div class="tab-content active" id="historyTab">
                        <div id="historyList">
                            <div class="history-item">No conversion history available</div>
                        </div>
                    </div>
                    <div class="tab-content" id="copyTab" style="display: none;">
                        <div class="history-item">Copy features coming soon</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="panels-container">
            <div class="panel">
                <div class="panel-header">
                    Input
                    <span class="format-indicator unknown" id="inputFormat">AUTO-DETECT</span>
                </div>
                <div class="panel-content">
                    <textarea 
                        class="panel-textarea" 
                        id="inputArea" 
                        placeholder='Paste your JSON, YAML, or XML here...

Example JSON:
{
  "name": "John Doe",
  "age": 30,
  "city": "New York"
}

Example YAML:
name: John Doe
age: 30
city: New York

Example XML:
<root>
  <name>John Doe</name>
  <age>30</age>
  <city>New York</city>
</root>'
                    ></textarea>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    Output
                    <span class="format-indicator unknown" id="outputFormat">RESULT</span>
                </div>
                <div class="panel-content">
                    <div class="formatted-output" id="outputArea"></div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <strong>Status:</strong>
                <span id="statusText">Ready - Paste JSON, YAML, or XML to auto-detect format</span>
            </div>
            <div class="status-item">
                <strong>Characters:</strong>
                <span id="charCount">0</span>
            </div>
        </div>
    </div>

    <!-- Global History Popup -->
    <div class="global-history-popup" id="globalHistoryPopup">
        <div class="global-history-header">
            <span>Global History - All Tools</span>
            <button onclick="converter?.toggleGlobalHistory()" style="background: none; border: none; cursor: pointer; font-size: 16px;">√ó</button>
        </div>
        <div class="global-history-content">
            <div id="globalHistoryList">
                <div class="global-history-item">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize converter when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Include the converter class inline to avoid external file issues
            class JsonYamlXmlConverter {
                constructor() {
                    this.toolName = 'json-yaml-xml-converter';
                    this.yamlIndentSize = 2;
                    this.currentInputFormat = 'unknown';
                    this.currentOutputFormat = 'unknown';
                    this.lastInputData = '';
                    
                    this.examples = {
                        json: `{
  "users": [
    {
      "id": 1,
      "name": "John Doe",
      "email": "john@example.com",
      "active": true,
      "roles": ["admin", "user"],
      "settings": {
        "theme": "dark",
        "notifications": true
      }
    },
    {
      "id": 2,
      "name": "Jane Smith",
      "email": "jane@example.com",
      "active": false,
      "roles": ["user"],
      "settings": null
    }
  ],
  "metadata": {
    "total": 2,
    "version": "1.0"
  }
}`,
                        yaml: `users:
  - id: 1
    name: John Doe
    email: john@example.com
    active: true
    roles:
      - admin
      - user
    settings:
      theme: dark
      notifications: true
  - id: 2
    name: Jane Smith
    email: jane@example.com
    active: false
    roles:
      - user
    settings: null
metadata:
  total: 2
  version: "1.0"`
                    };
                    
                    this.init();
                    this.loadHistory();
                    this.initHistoryToggle();
                }

                init() {
                    this.bindEvents();
                    this.updateCharCount();
                    this.updateFormatIndicators();
                }

                bindEvents() {
                    // Main conversion buttons
                    document.getElementById('convertToJson').addEventListener('click', () => this.convertTo('json'));
                    document.getElementById('convertToYaml').addEventListener('click', () => this.convertTo('yaml'));
                    document.getElementById('convertToXml').addEventListener('click', () => this.convertTo('xml'));
                    
                    // Utility buttons
                    document.getElementById('formatBtn').addEventListener('click', () => this.formatCurrent());
                    document.getElementById('swapBtn').addEventListener('click', () => this.swapContent());
                    document.getElementById('clearBtn').addEventListener('click', () => this.clearAll());
                    document.getElementById('copyBtn').addEventListener('click', () => this.copyOutput());
                    
                    // Example buttons
                    document.getElementById('jsonExampleBtn').addEventListener('click', () => this.loadExample('json'));
                    document.getElementById('yamlExampleBtn').addEventListener('click', () => this.loadExample('yaml'));
                    
                    // Settings
                    document.getElementById('yamlIndent').addEventListener('change', () => this.updateYamlPreference());
                    
                    // Input handling
                    const inputArea = document.getElementById('inputArea');
                    inputArea.addEventListener('input', () => {
                        this.updateCharCount();
                        clearTimeout(this.detectTimer);
                        this.detectTimer = setTimeout(() => this.autoDetectFormat(), 500);
                    });

                    // History buttons
                    document.getElementById('historyBtn').addEventListener('click', () => this.toggleHistory());
                    document.getElementById('globalHistoryBtn').addEventListener('click', () => this.toggleGlobalHistory());
                    document.getElementById('historyToggleBtn').addEventListener('click', () => this.toggleHistoryEnabled());
                    
                    // Handle outside clicks to close popups
                    document.addEventListener('click', (e) => this.handleOutsideClick(e));

                    // History tabs
                    document.querySelectorAll('.history-tab').forEach(tab => {
                        tab.addEventListener('click', (e) => this.switchHistoryTab(e));
                    });
                }

                loadExample(format) {
                    const inputArea = document.getElementById('inputArea');
                    inputArea.value = this.examples[format];
                    this.currentInputFormat = format;
                    this.updateFormatIndicators();
                    this.updateCharCount();
                    this.updateStatus(`${format.toUpperCase()} example loaded - try converting to other formats`);
                }

                convertTo(targetFormat) {
                    const input = document.getElementById('inputArea').value.trim();
                    const output = document.getElementById('outputArea');
                    
                    if (!input) {
                        this.updateStatus('Please enter some content to convert');
                        return;
                    }

                    try {
                        const inputFormat = this.detectFormat(input);
                        
                        if (inputFormat === 'unknown') {
                            this.updateStatus('Could not detect input format');
                            return;
                        }

                        let result = '';
                        let highlightedResult = '';

                        // Convert between formats
                        if (inputFormat === 'json' && targetFormat === 'yaml') {
                            result = this.jsonToYaml(input);
                            highlightedResult = this.syntaxHighlightYaml(result);
                        } else if (inputFormat === 'yaml' && targetFormat === 'json') {
                            result = this.yamlToJson(input);
                            highlightedResult = this.syntaxHighlightJson(result);
                        } else if (inputFormat === 'json' && targetFormat === 'xml') {
                            result = this.jsonToXml(input);
                            highlightedResult = this.syntaxHighlightXml(result);
                        } else if (inputFormat === 'xml' && targetFormat === 'json') {
                            result = this.xmlToJson(input);
                            highlightedResult = this.syntaxHighlightJson(result);
                        } else if (inputFormat === targetFormat) {
                            // Same format - just format nicely
                            if (targetFormat === 'json') {
                                const parsed = JSON.parse(input);
                                result = JSON.stringify(parsed, null, 2);
                                highlightedResult = this.syntaxHighlightJson(result);
                            }
                            this.updateStatus(`${targetFormat.toUpperCase()} formatted`);
                        } else {
                            this.updateStatus(`Direct ${inputFormat} to ${targetFormat} conversion not yet implemented`);
                            return;
                        }

                        output.innerHTML = highlightedResult;
                        this.currentInputFormat = inputFormat;
                        this.currentOutputFormat = targetFormat;
                        this.updateFormatIndicators();

                        if (inputFormat !== targetFormat) {
                            this.updateStatus(`Converted ${inputFormat.toUpperCase()} to ${targetFormat.toUpperCase()}`);
                            // Save to history only on actual conversions
                            this.saveToHistoryIfChanged(input, `${inputFormat}-to-${targetFormat}`);
                        }

                    } catch (error) {
                        output.innerHTML = `<div class="error-display">Error: ${error.message}</div>`;
                        this.updateStatus(`Conversion error: ${error.message}`);
                    }
                }

                detectFormat(content) {
                    if (!content.trim()) return 'unknown';
                    content = content.trim();

                    // Check for XML
                    if (content.startsWith('<?xml') || (content.startsWith('<') && content.endsWith('>'))) {
                        try {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(content, 'text/xml');
                            if (!doc.getElementsByTagName('parsererror').length) {
                                return 'xml';
                            }
                        } catch (e) {}
                    }

                    // Check for JSON
                    try {
                        JSON.parse(content);
                        return 'json';
                    } catch (e) {}

                    // Check for YAML
                    if (content.includes(':') && !content.startsWith('{') && !content.startsWith('[')) {
                        return 'yaml';
                    }

                    return 'unknown';
                }

                autoDetectFormat() {
                    const input = document.getElementById('inputArea').value.trim();
                    if (!input) return;

                    const detectedFormat = this.detectFormat(input);
                    if (detectedFormat !== 'unknown' && detectedFormat !== this.currentInputFormat) {
                        this.currentInputFormat = detectedFormat;
                        this.updateFormatIndicators();
                    }
                }

                // Simplified conversion methods for basic functionality
                jsonToYaml(jsonStr) {
                    const obj = JSON.parse(jsonStr);
                    return this.objectToYaml(obj, 0);
                }

                objectToYaml(obj, indent = 0) {
                    const spaces = ' '.repeat(indent);
                    
                    if (obj === null) return 'null';
                    if (typeof obj === 'boolean') return obj.toString();
                    if (typeof obj === 'number') return obj.toString();
                    if (typeof obj === 'string') return obj;

                    if (Array.isArray(obj)) {
                        if (obj.length === 0) return '[]';
                        return obj.map(item => {
                            const yamlItem = this.objectToYaml(item, indent + this.yamlIndentSize);
                            return `${spaces}- ${yamlItem}`;
                        }).join('\n');
                    }

                    if (typeof obj === 'object') {
                        if (Object.keys(obj).length === 0) return '{}';
                        return Object.entries(obj).map(([key, value]) => {
                            const yamlValue = this.objectToYaml(value, indent + this.yamlIndentSize);
                            if (typeof value === 'object' && value !== null) {
                                return `${spaces}${key}:\n${yamlValue}`;
                            }
                            return `${spaces}${key}: ${yamlValue}`;
                        }).join('\n');
                    }

                    return String(obj);
                }

                yamlToJson(yamlStr) {
                    // Very basic YAML parser - for demo purposes
                    const lines = yamlStr.split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
                    const result = {};
                    
                    for (const line of lines) {
                        if (line.includes(':')) {
                            const [key, value] = line.split(':').map(s => s.trim());
                            if (value) {
                                result[key] = isNaN(value) ? value : Number(value);
                            }
                        }
                    }
                    
                    return JSON.stringify(result, null, 2);
                }

                jsonToXml(jsonStr) {
                    const obj = JSON.parse(jsonStr);
                    let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
                    xml += this.objectToXml(obj, 'root', 0);
                    return xml;
                }

                objectToXml(obj, tagName, indent = 0) {
                    const spaces = '  '.repeat(indent);

                    if (obj === null) {
                        return `${spaces}<${tagName}></${tagName}>`;
                    }

                    if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {
                        return `${spaces}<${tagName}>${obj}</${tagName}>`;
                    }

                    if (Array.isArray(obj)) {
                        let xml = '';
                        obj.forEach(item => {
                            xml += this.objectToXml(item, 'item', indent) + '\n';
                        });
                        return xml.trimEnd();
                    }

                    if (typeof obj === 'object') {
                        let xml = `${spaces}<${tagName}>\n`;
                        Object.entries(obj).forEach(([key, value]) => {
                            xml += this.objectToXml(value, key, indent + 1) + '\n';
                        });
                        xml += `${spaces}</${tagName}>`;
                        return xml;
                    }

                    return `${spaces}<${tagName}>${obj}</${tagName}>`;
                }

                xmlToJson(xmlStr) {
                    // Basic XML to JSON conversion for demo
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xmlStr, 'text/xml');
                    const result = this.xmlNodeToObject(doc.documentElement);
                    return JSON.stringify(result, null, 2);
                }

                xmlNodeToObject(node) {
                    const obj = {};
                    
                    if (node.childNodes.length === 1 && node.childNodes[0].nodeType === 3) {
                        return node.textContent;
                    }
                    
                    for (const child of node.childNodes) {
                        if (child.nodeType === 1) {
                            obj[child.tagName] = this.xmlNodeToObject(child);
                        }
                    }
                    
                    return obj;
                }

                // Syntax highlighting
                syntaxHighlightJson(json) {
                    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                        let cls = 'json-number';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'json-key';
                            } else {
                                cls = 'json-string';
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'json-boolean';
                        } else if (/null/.test(match)) {
                            cls = 'json-null';
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    });
                }

                syntaxHighlightYaml(yaml) {
                    return yaml.replace(/^(\s*)([^:\s][^:]*?)(\s*:)(\s*)(.*)$/gm, function(match, indent, key, colon, space, value) {
                        let highlightedValue = value;
                        if (value.match(/^\s*(true|false)\s*$/)) {
                            highlightedValue = value.replace(/(true|false)/, '<span class="yaml-boolean">$1</span>');
                        } else if (value.match(/^\s*\d+\s*$/)) {
                            highlightedValue = '<span class="yaml-number">' + value + '</span>';
                        } else if (value.trim()) {
                            highlightedValue = '<span class="yaml-string">' + value + '</span>';
                        }
                        return indent + '<span class="yaml-key">' + key + '</span>' + colon + space + highlightedValue;
                    });
                }

                syntaxHighlightXml(xml) {
                    xml = xml.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return xml.replace(/(&lt;\/?)([a-zA-Z_][\w\-]*)(.*?)(\/?&gt;)/g, '<span class="xml-tag">$1$2$3$4</span>');
                }

                // Utility functions
                formatCurrent() {
                    const input = document.getElementById('inputArea').value.trim();
                    if (!input) return;

                    const format = this.detectFormat(input);
                    if (format === 'json') {
                        try {
                            const parsed = JSON.parse(input);
                            document.getElementById('inputArea').value = JSON.stringify(parsed, null, 2);
                            this.updateCharCount();
                            this.updateStatus('JSON formatted');
                        } catch (e) {
                            this.updateStatus('Invalid JSON format');
                        }
                    }
                }

                swapContent() {
                    const inputEl = document.getElementById('inputArea');
                    const outputEl = document.getElementById('outputArea');
                    const outputText = outputEl.textContent;
                    
                    if (!outputText.trim()) {
                        this.updateStatus('No output content to swap');
                        return;
                    }

                    inputEl.value = outputText;
                    outputEl.innerHTML = '';
                    
                    const temp = this.currentInputFormat;
                    this.currentInputFormat = this.currentOutputFormat;
                    this.currentOutputFormat = 'unknown';
                    
                    this.updateFormatIndicators();
                    this.updateCharCount();
                    this.updateStatus('Content swapped between panels');
                }

                clearAll() {
                    document.getElementById('inputArea').value = '';
                    document.getElementById('outputArea').innerHTML = '';
                    this.currentInputFormat = 'unknown';
                    this.currentOutputFormat = 'unknown';
                    this.updateFormatIndicators();
                    this.updateCharCount();
                    this.updateStatus('Ready - Paste JSON, YAML, or XML to auto-detect format');
                }

                copyOutput() {
                    const output = document.getElementById('outputArea');
                    const text = output.textContent;
                    
                    if (!text.trim()) {
                        this.updateStatus('No output content to copy');
                        return;
                    }

                    navigator.clipboard.writeText(text).then(() => {
                        this.updateStatus('Copied to clipboard');
                    }).catch(() => {
                        this.updateStatus('Copy failed');
                    });
                }

                updateYamlPreference() {
                    this.yamlIndentSize = parseInt(document.getElementById('yamlIndent').value);
                }

                updateCharCount() {
                    const input = document.getElementById('inputArea').value;
                    document.getElementById('charCount').textContent = input.length;
                }

                updateFormatIndicators() {
                    const inputIndicator = document.getElementById('inputFormat');
                    const outputIndicator = document.getElementById('outputFormat');
                    
                    inputIndicator.textContent = this.currentInputFormat.toUpperCase();
                    outputIndicator.textContent = this.currentOutputFormat.toUpperCase();
                    
                    inputIndicator.className = `format-indicator ${this.currentInputFormat}`;
                    outputIndicator.className = `format-indicator ${this.currentOutputFormat}`;
                }

                updateStatus(message) {
                    document.getElementById('statusText').textContent = message;
                }

                toggleHistory() {
                    const popup = document.getElementById('historyPopup');
                    popup.classList.toggle('show');
                    if (popup.classList.contains('show')) {
                        this.loadHistory();
                    }
                }

                toggleGlobalHistory() {
                    const popup = document.getElementById('globalHistoryPopup');
                    popup.classList.toggle('show');
                    if (popup.classList.contains('show')) {
                        this.loadGlobalHistory();
                    }
                }

                clearHistory() {
                    this.updateStatus('History cleared');
                    document.getElementById('historyList').innerHTML = '<div class="history-item">No conversion history available</div>';
                }

                // History API Methods
                async saveToHistoryIfChanged(data, operation) {
                    // Only save if the data is different from the last saved data
                    if (data !== this.lastInputData) {
                        this.lastInputData = data;
                        await this.saveToHistory(data, operation);
                    }
                }

                async saveToHistory(data, operation) {
                    try {
                        const response = await fetch(`/api/history/${this.toolName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                data: data,
                                operation: operation
                            })
                        });

                        if (response.ok) {
                            this.loadHistory(); // Refresh history display
                        }
                    } catch (error) {
                        console.error('Error saving history:', error);
                    }
                }

                async loadHistory() {
                    try {
                        const response = await fetch(`/api/history/${this.toolName}?limit=20`);
                        const result = await response.json();
                        
                        this.displayHistory(result.history || []);
                    } catch (error) {
                        console.error('Error loading history:', error);
                        document.getElementById('historyList').innerHTML = '<div class="history-item">Failed to load history</div>';
                    }
                }

                displayHistory(history) {
                    const historyList = document.getElementById('historyList');
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="history-item">No conversion history available</div>';
                        return;
                    }

                    const historyHtml = history.map(item => `
                        <div class="history-item" data-id="${item.id}">
                            <div class="history-item-header">
                                <div class="history-item-content">
                                    <input type="checkbox" class="history-checkbox" data-id="${item.id}" onclick="event.stopPropagation()">
                                    <div class="history-meta">
                                        <span class="history-id">ID: ${item.id}</span>
                                        <span class="history-date">${this.formatTimestamp(item.timestamp)} - ${item.operation}</span>
                                    </div>
                                </div>
                                <button class="history-delete-btn" onclick="converter.deleteHistoryItem('${item.id}'); event.stopPropagation();">√ó</button>
                            </div>
                            <div class="history-preview">${item.preview}</div>
                        </div>
                    `).join('');

                    historyList.innerHTML = historyHtml;

                    // Add click listeners to history items (excluding checkbox clicks)
                    historyList.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                const entryId = item.dataset.id;
                                this.loadHistoryEntry(entryId);
                            }
                        });
                    });

                    // Add checkbox event listeners
                    historyList.querySelectorAll('.history-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            this.handleHistorySelection(e.target.dataset.id, e.target.checked);
                        });
                    });
                }

                /**
                 * Handle history item selection
                 */
                handleHistorySelection(entryId, isSelected) {
                    if (!this.selectedHistoryItems) {
                        this.selectedHistoryItems = new Set();
                    }
                    
                    if (isSelected) {
                        this.selectedHistoryItems.add(entryId);
                    } else {
                        this.selectedHistoryItems.delete(entryId);
                    }
                    
                    // Update selection UI or enable/disable bulk actions
                    this.updateHistorySelectionUI();
                }

                /**
                 * Update UI based on history selections
                 */
                updateHistorySelectionUI() {
                    const selectedCount = this.selectedHistoryItems ? this.selectedHistoryItems.size : 0;
                    
                    // Add/update selection counter and action buttons if needed
                    let selectionInfo = document.querySelector('.history-selection-info');
                    const historyPopup = document.getElementById('historyPopup');
                    if (!selectionInfo) {
                        selectionInfo = document.createElement('div');
                        selectionInfo.className = 'history-selection-info';
                        historyPopup.insertBefore(selectionInfo, historyPopup.firstChild);
                    }
                    
                    if (selectedCount > 0) {
                        selectionInfo.innerHTML = `
                            <div style="padding: 8px; background: #e3f2fd; border-bottom: 1px solid #90caf9; font-size: 11px;">
                                ${selectedCount} item${selectedCount > 1 ? 's' : ''} selected
                                <button onclick="converter.clearHistorySelection()" style="float: right; background: none; border: none; color: #1976d2; cursor: pointer;">Clear</button>
                            </div>
                        `;
                    } else {
                        selectionInfo.innerHTML = '';
                    }
                }

                /**
                 * Clear history selection
                 */
                clearHistorySelection() {
                    this.selectedHistoryItems?.clear();
                    // Uncheck all checkboxes
                    document.getElementById('historyList').querySelectorAll('.history-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    this.updateHistorySelectionUI();
                }

                /**
                 * Handle clicks outside history popups to close them
                 */
                handleOutsideClick(event) {
                    const historyPopup = document.getElementById('historyPopup');
                    const historyBtn = document.getElementById('historyBtn');
                    const globalHistoryPopup = document.getElementById('globalHistoryPopup');
                    const globalHistoryBtn = document.getElementById('globalHistoryBtn');
                    
                    // Close local history popup if clicking outside
                    if (historyPopup && historyPopup.classList.contains('show') &&
                        !historyPopup.contains(event.target) && !historyBtn.contains(event.target)) {
                        historyPopup.classList.remove('show');
                    }
                    
                    // Close global history popup if clicking outside  
                    if (globalHistoryPopup && globalHistoryPopup.classList.contains('show') &&
                        !globalHistoryPopup.contains(event.target) && !globalHistoryBtn.contains(event.target)) {
                        globalHistoryPopup.classList.remove('show');
                    }
                }

                /**
                 * Switch between history tabs
                 */
                switchHistoryTab(event) {
                    const clickedTab = event.target;
                    const targetTab = clickedTab.dataset.tab;
                    
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.history-tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    // Activate clicked tab and corresponding content
                    clickedTab.classList.add('active');
                    const targetContent = document.getElementById(targetTab + 'Tab');
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                    }
                }

                async loadHistoryEntry(entryId) {
                    try {
                        const response = await fetch(`/api/history/${this.toolName}/${entryId}`);
                        const entry = await response.json();
                        
                        if (entry && entry.data) {
                            document.getElementById('inputArea').value = entry.data;
                            this.updateCharCount();
                            this.autoDetectFormat();
                            this.toggleHistory(); // Close history popup
                            this.updateStatus('History entry loaded');
                        }
                    } catch (error) {
                        console.error('Error loading history entry:', error);
                        this.updateStatus('Failed to load history entry');
                    }
                }

                // Global History Methods
                async loadGlobalHistory() {
                    try {
                        const response = await fetch(`/api/global-history?limit=50`);
                        const result = await response.json();
                        
                        this.displayGlobalHistory(result.history || []);
                    } catch (error) {
                        console.error('Error loading global history:', error);
                        document.getElementById('globalHistoryList').innerHTML = '<div class="global-history-item">Failed to load global history</div>';
                    }
                }

                displayGlobalHistory(history) {
                    const historyList = document.getElementById('globalHistoryList');
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="global-history-item">No global history available</div>';
                        return;
                    }

                    const historyHtml = history.map(item => `
                        <div class="global-history-item" data-id="${item.id}" data-tool="${item.tool_name}">
                            <div class="global-history-item-header">
                                <input type="checkbox" class="global-history-checkbox" data-id="${item.id}" onclick="event.stopPropagation()">
                                <div class="global-history-item-meta">
                                    <div class="global-history-id-tool">
                                        <span class="history-id">ID: ${item.id}</span>
                                        <span class="global-history-tool-label" style="background-color: ${this.getToolColor(item.tool_name)}">${item.tool_name}</span>
                                    </div>
                                    <span class="history-date">${this.formatTimestamp(item.timestamp)} - ${item.operation}</span>
                                </div>
                                <button class="history-delete-btn" onclick="converter.deleteGlobalHistoryItem('${item.id}'); event.stopPropagation();">√ó</button>
                            </div>
                            <div class="history-preview">${item.preview}</div>
                        </div>
                    `).join('');

                    historyList.innerHTML = historyHtml;

                    // Add click listeners to global history items (allow cross-tool loading)
                    historyList.querySelectorAll('.global-history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const entryId = item.dataset.id;
                            const toolName = item.dataset.tool;
                            this.loadGlobalHistoryEntry(entryId, toolName);
                        });
                    });
                }

                async loadGlobalHistoryEntry(entryId, toolName) {
                    try {
                        const response = await fetch(`/api/global-history/${entryId}`);
                        const entry = await response.json();
                        
                        if (entry && entry.data) {
                            document.getElementById('inputArea').value = entry.data;
                            this.updateCharCount();
                            this.autoDetectFormat();
                            this.toggleGlobalHistory(); // Close global history popup
                            
                            if (toolName === this.toolName) {
                                this.updateStatus('Global history entry loaded');
                            } else {
                                this.updateStatus(`Loaded ${toolName} data into converter - auto-detecting format`);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading global history entry:', error);
                        this.updateStatus('Failed to load global history entry');
                    }
                }

                formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }

                // Tool color mapping for global history
                getToolColor(toolName) {
                    const colors = {
                        'json-formatter': '#2196F3',
                        'json-yaml-xml-converter': '#4CAF50',
                        'base64-encoder-decoder': '#FF9800',
                        'url-encoder-decoder': '#9C27B0',
                        'hash-generator': '#F44336',
                        'qr-code-generator': '#607D8B'
                    };
                    return colors[toolName] || '#757575';
                }

                // History deletion methods
                async deleteHistoryItem(entryId) {
                    try {
                        const response = await fetch(`/api/history/${this.toolName}/${entryId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            this.loadHistory(); // Refresh local history display
                            this.loadGlobalHistory(); // Refresh global history display
                            this.updateStatus('History item deleted');
                        } else {
                            this.updateStatus('Failed to delete history item');
                        }
                    } catch (error) {
                        console.error('Error deleting history item:', error);
                        this.updateStatus('Error deleting history item');
                    }
                }

                async deleteGlobalHistoryItem(entryId) {
                    try {
                        const response = await fetch(`/api/global-history/${entryId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            this.loadHistory(); // Refresh local history display
                            this.loadGlobalHistory(); // Refresh global history display
                            this.updateStatus('Global history item deleted');
                        } else {
                            this.updateStatus('Failed to delete global history item');
                        }
                    } catch (error) {
                        console.error('Error deleting global history item:', error);
                        this.updateStatus('Error deleting global history item');
                    }
                }

                // History enable/disable functionality
                initHistoryToggle() {
                    const saved = localStorage.getItem(`${this.toolName}_historyEnabled`);
                    this.historyEnabled = saved !== null ? JSON.parse(saved) : true;
                    this.updateHistoryToggleUI();
                }

                toggleHistoryEnabled() {
                    this.historyEnabled = !this.historyEnabled;
                    localStorage.setItem(`${this.toolName}_historyEnabled`, JSON.stringify(this.historyEnabled));
                    this.updateHistoryToggleUI();
                    
                    const status = this.historyEnabled ? 'enabled' : 'disabled';
                    this.updateStatus(`History ${status}`);
                }

                updateHistoryToggleUI() {
                    const btn = document.getElementById('historyToggleBtn');
                    if (this.historyEnabled) {
                        btn.textContent = 'üìù History On';
                        btn.classList.remove('disabled');
                    } else {
                        btn.textContent = 'üìù History Off';
                        btn.classList.add('disabled');
                    }
                }

                // Override saveToHistoryIfChanged to check if history is enabled
                async saveToHistoryIfChanged(data, operation) {
                    if (!this.historyEnabled) {
                        return; // Skip saving if history is disabled
                    }
                    
                    // Only save if the data is different from the last saved data
                    if (data !== this.lastInputData) {
                        this.lastInputData = data;
                        await this.saveToHistory(data, operation);
                    }
                }
            }

            // Initialize the converter
            window.converter = new JsonYamlXmlConverter();
        });
    </script>
</body>
</html>